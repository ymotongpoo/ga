# 実装計画

- [x] 1. プロジェクト構造とコア インターフェースの設定
  - Go モジュールの初期化とディレクトリ構造の作成
  - 各サービスのインターフェース定義
  - _要件: 6.1, 6.3_

- [x] 2. コマンドライン インターフェースの実装
- [x] 2.1 CLI オプション解析の実装
  - CLIOptions 構造体とコマンドライン引数解析の実装
  - --help, --version, --login, --config オプションの処理
  - _要件: 7.1, 7.2, 7.4, 7.5_

- [x] 2.3 新しい CLI オプションの追加
  - --format オプション（csv/json）の実装
  - --output オプション（出力ファイル指定）の実装
  - デフォルト値の設定とバリデーション
  - _要件: 7.6, 7.7, 7.8_

- [x] 2.2 メインコマンドハンドラーの実装
  - メインアプリケーションロジックの実装
  - 適切な終了コードの管理
  - _要件: 6.3, 5.5_

- [x] 3. 設定ファイル処理の実装
- [x] 3.1 YAML 設定ファイル読み込み機能の実装
  - Config 構造体と YAML パーサーの実装
  - 設定ファイルの存在確認とエラーハンドリング
  - _要件: 2.1, 2.2, 2.3_

- [x] 3.2 設定ファイル検証機能の実装
  - 必須項目の検証ロジック
  - 日付形式とID形式の検証
  - _要件: 2.4_

- [x] 4. OAuth2 認証システムの実装
- [x] 4.1 OAuth2 認証フローの実装
  - Google Analytics API 用の OAuth2 設定
  - ブラウザベースの認証フロー
  - _要件: 1.1_

- [x] 4.2 トークン管理機能の実装
  - 認証トークンの安全な保存
  - トークンの自動更新機能
  - _要件: 1.3, 1.5_

- [x] 4.3 認証エラーハンドリングの実装
  - 認証失敗時のエラーメッセージ
  - 認証状態の検証
  - _要件: 1.4_

- [x] 4.4 OAuth2フローのOOBからオフラインアクセスフローへの修正
- [x] 4.4.1 ローカルHTTPサーバー実装
  - LocalServer構造体の実装
  - `/callback` エンドポイントの実装
  - 認証コード受信とチャネル通信の実装
  - _要件: 1.2, 1.7_

- [x] 4.4.2 OAuth2設定の修正
  - RedirectURLを `http://localhost:8080/callback` に変更
  - OOB設定 `urn:ietf:wg:oauth:2.0:oob` の削除
  - OAuth2 state パラメータの追加
  - _要件: 1.6, 1.7_

- [x] 4.4.3 認証フロー処理の修正
  - ローカルサーバー起動処理の実装
  - ブラウザ自動起動機能の実装
  - 認証完了後のサーバー停止処理
  - タイムアウト処理の実装
  - _要件: 1.2, 1.8_

- [x] 4.4.4 エラーハンドリングの強化
  - ローカルサーバー起動失敗時の処理
  - ポート使用中エラーの処理
  - 認証タイムアウト時の処理
  - _要件: 1.4_

- [x] 4.4.5 セキュリティ強化
  - CSRF攻撃防止のためのstate検証
  - ローカルサーバーのlocalhost制限
  - トークンファイル権限の適切な設定
  - _要件: 1.3_

- [x] 5. Google Analytics 4 API クライアントの実装
- [x] 5.1 GA4 API クライアントの基本実装
  - Google Analytics Reporting API v4 の統合
  - API 接続とリクエスト処理
  - _要件: 3.1_

- [x] 5.2 データ取得機能の実装
  - 指定されたメトリクス（sessions, activeUsers, newUsers, averageSessionDuration）の取得
  - 複数プロパティ対応
  - _要件: 3.2, 3.5_

- [x] 5.3 API エラーハンドリングとリトライ機能の実装
  - API 制限とネットワークエラーの処理
  - 指数バックオフによるリトライ機能
  - _要件: 3.3, 5.2, 5.3_

- [x] 5.4 データ取得完了通知の実装
  - 取得レコード数の表示
  - プログレス表示機能
  - _要件: 3.4_

- [x] 6. CSV 出力機能の実装
- [x] 6.1 CSV ライターの実装
  - ReportData から CSV 形式への変換
  - UTF-8 エンコーディング対応
  - _要件: 4.1, 4.2, 4.5_

- [x] 6.2 出力先管理の実装
  - 標準出力とファイル出力の切り替え
  - ファイル出力時のエラーハンドリング
  - _要件: 4.3, 4.4_

- [x] 6.3 JSON 出力機能の実装
- [x] 6.3.1 JSON データ構造の実装
  - JSONRecord、JSONMetadata 構造体の実装
  - ディメンションとメトリクスのキー・バリューペア変換
  - メタデータ（取得日時、プロパティ情報）の生成
  - _要件: 4.6, 4.12_

- [x] 6.3.2 JSON ライターの実装
  - ReportData から JSON 形式への変換
  - 構造化された JSON 配列の生成
  - UTF-8 エンコーディング対応
  - _要件: 4.6, 4.9_

- [x] 6.3.3 出力形式選択機能の実装
  - OutputFormat 列挙型の実装
  - --format オプションの処理
  - デフォルト形式（CSV）の設定
  - 無効な形式指定時のエラーハンドリング
  - _要件: 4.2, 4.3, 4.4, 4.8_

- [x] 6.3.4 統合出力サービスの更新
  - OutputService インターフェースの更新
  - WriteJSON メソッドの実装
  - WriteToFile、WriteToConsole メソッドの形式対応
  - _要件: 4.7, 4.8_

- [x] 7. エラーハンドリングとログ機能の実装
- [x] 7.1 エラー分類システムの実装
  - GAError 構造体と ErrorType の実装
  - エラーメッセージの標準化
  - _要件: 5.1_

- [x] 7.2 デバッグモードとログ機能の実装
  - デバッグモード時の詳細ログ出力
  - ログレベルの管理
  - _要件: 5.4_

- [x] 8. 統合とテストの実装
- [x] 8.1 単体テストの実装
  - 各サービスの単体テスト
  - モックを使用した API テスト
  - _要件: 全要件のテストカバレッジ_

- [x] 8.2 統合テストの実装
  - サービス間連携のテスト
  - エンドツーエンドワークフローのテスト
  - _要件: 全要件の統合テスト_

- [x] 8.3 JSON 出力機能のテスト実装
  - JSON ライターの単体テスト
  - JSON 構造とスキーマの検証テスト
  - CSV と JSON 出力の比較テスト
  - 出力形式選択機能のテスト
  - _要件: 4.2, 4.6, 4.12_

- [x] 9. 最終統合とドキュメント
- [x] 9.1 全機能の統合
  - 全コンポーネントの統合
  - 最終的な動作確認
  - _要件: 全要件_

- [x] 9.2 使用方法ドキュメントの作成
  - README.md の更新
  - 設定ファイル例の作成
  - _要件: 7.1_

- [ ] 10. URL結合機能の実装
- [ ] 10.1 設定ファイルのbase_url対応
  - Stream構造体にBaseURLフィールドを追加
  - YAML設定ファイルでbase_urlの読み込み対応
  - 設定ファイル検証でbase_urlの妥当性チェック
  - _要件: 6.1, 6.4_

- [ ] 10.2 URL結合処理ロジックの実装
  - URLProcessor構造体の実装
  - ProcessPagePath関数の実装
  - 絶対URL、相対パス、空文字列の適切な処理
  - スラッシュ重複の処理ロジック
  - _要件: 6.2, 6.3, 6.6, 6.7_

- [ ] 10.3 CSV出力でのURL結合処理統合
  - ReportDataにStreamURLsマッピングを追加
  - CSV出力時のpagePathとbase_urlの結合処理
  - ヘッダー名の変更（pagePath → fullURL）
  - _要件: 6.5_

- [ ] 10.4 URL結合機能のテスト実装
  - URL結合ロジックの単体テスト
  - 各種パターン（絶対URL、相対パス、空文字列）のテストケース
  - CSV出力での結合処理の統合テスト
  - _要件: 6.1-6.7_